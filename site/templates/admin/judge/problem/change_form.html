{% extends "admin/change_form.html" %}
{% load i18n %}

{% block extrahead %}{{ block.super }}
    <script type="text/javascript">
        django.jQuery(function ($) {
            $('.submissions-link').appendTo('div#bottombar').show();
        });
    </script>
    <script type="text/javascript">
        django.jQuery(function ($) {
            var $sampleInput = $('#id_sample_input');
            var $sampleOutput = $('#id_sample_output');
            if (!$sampleInput.length || !$sampleOutput.length) {
                return;
            }
            if ($('#sample-io-add').length) {
                return;
            }

            var separator = '\n<<<SAMPLE_SPLIT>>>\n';
            var $inputRow = $sampleInput.closest('.form-row');
            var $outputRow = $sampleOutput.closest('.form-row');
            if (!$inputRow.length || !$outputRow.length) {
                return;
            }

            function normalizeLabel(text) {
                var trimmed = $.trim(text);
                if (!trimmed) {
                    return '';
                }
                return trimmed.replace(/\s*\d+\s*:?$/, ':').replace(/\s*:\s*$/, ':');
            }

            function formatLabel(base, index, total) {
                if (!base) {
                    return '';
                }
                if (total === 1) {
                    return base;
                }
                var hasColon = /:$/.test(base);
                var stripped = base.replace(/:\s*$/, '');
                return hasColon ? (stripped + ' ' + index + ':') : (base + ' ' + index);
            }

            function splitSamples(value) {
                if (!value) {
                    return [];
                }
                return value.split(separator).filter(function (item) {
                    return $.trim(item);
                });
            }

            function buildRow($row, kind, value, addDeleteButton) {
                var $clone = $row.clone(false, false);
                $clone.find('textarea').val(value || '')
                    .removeAttr('id')
                    .removeAttr('name')
                    .attr('data-sample-kind', kind);
                $clone.find('label').removeAttr('for');
                $clone.find('.help, .errorlist').remove();

                // input에만 삭제 버튼 추가
                if (kind === 'input' && addDeleteButton) {
                    $clone.css('position', 'relative');
                    // 레이블과 같은 라인에 배치
                    var $label = $clone.find('label').first();
                    $label.css({'display': 'inline-block', 'line-height': '24px'});
                    var $deleteBtn = $('<button type="button" class="sample-delete-btn" style="background: #dc3545; color: white; border: none; border-radius: 4px; width: 24px; height: 24px; cursor: pointer; font-size: 16px; font-weight: bold; line-height: 1; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; margin-left: 8px; vertical-align: middle; box-shadow: 0 1px 3px rgba(220, 53, 69, 0.3);">×</button>');
                    $label.after($deleteBtn);
                }

                return $clone;
            }

            var inputBase = normalizeLabel($inputRow.find('label').first().text()) || 'Sample input:';
            var outputBase = normalizeLabel($outputRow.find('label').first().text()) || 'Sample output:';

            var inputs = splitSamples($sampleInput.val());
            var outputs = splitSamples($sampleOutput.val());
            if (inputs.length) {
                $sampleInput.val(inputs[0]);
            }
            if (outputs.length) {
                $sampleOutput.val(outputs[0]);
            }

            var $extraContainer = $('<div id="sample-io-extra"></div>');
            var extraCount = Math.max(inputs.length, outputs.length) - 1;
            if (extraCount < 0) {
                extraCount = 0;
            }
            for (var i = 0; i < extraCount; i++) {
                var $pair = $('<div class="sample-io-pair"></div>');
                $pair.append(buildRow($inputRow, 'input', inputs[i + 1] || '', true));
                $pair.append(buildRow($outputRow, 'output', outputs[i + 1] || '', false));
                $extraContainer.append($pair);
            }

            // + 버튼을 전체 너비로 생성 (label 영역 제거)
            var $buttonWrapper = $('<div class="sample-io-add-row" style="margin-top: 15px;"></div>');
            var $buttonField = $('<button type="button" class="button sample-io-btn" id="sample-io-add" style="background: #5b9bd5; color: white; border: none; border-radius: 8px; padding: 18px; cursor: pointer; font-size: 15px; font-weight: 500; transition: all 0.3s ease; width: 100%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(91, 155, 213, 0.25); position: relative; overflow: hidden;">+ Add Test Case</button>');
            $buttonWrapper.append($buttonField);
            // container를 먼저 추가하고 버튼을 그 뒤에 추가
            $outputRow.after($extraContainer);
            $extraContainer.after($buttonWrapper);

            function updateLabels() {
                var total = 1 + $extraContainer.find('.sample-io-pair').length;
                $inputRow.find('label').first().text(formatLabel(inputBase, 1, total));
                $outputRow.find('label').first().text(formatLabel(outputBase, 1, total));
                $extraContainer.find('.sample-io-pair').each(function (idx) {
                    var index = idx + 2;
                    $(this).find('label').first().text(formatLabel(inputBase, index, total));
                    $(this).find('label').last().text(formatLabel(outputBase, index, total));
                });
            }

            $buttonField.on('click', function () {
                var $pair = $('<div class="sample-io-pair"></div>');
                $pair.append(buildRow($inputRow, 'input', '', true));
                $pair.append(buildRow($outputRow, 'output', '', false));
                $extraContainer.append($pair);
                updateLabels();
            });

            // 삭제 버튼 이벤트 (동적으로 추가된 버튼에도 작동)
            $extraContainer.on('click', '.sample-delete-btn', function () {
                $(this).closest('.sample-io-pair').remove();
                updateLabels();
            });

            updateLabels();

            $sampleInput.closest('form').on('submit', function () {
                var allInputs = [$sampleInput.val()];
                var allOutputs = [$sampleOutput.val()];
                $extraContainer.find('textarea[data-sample-kind="input"]').each(function () {
                    allInputs.push($(this).val());
                });
                $extraContainer.find('textarea[data-sample-kind="output"]').each(function () {
                    allOutputs.push($(this).val());
                });

                while (allInputs.length && !$.trim(allInputs[allInputs.length - 1])) {
                    allInputs.pop();
                }
                while (allOutputs.length && !$.trim(allOutputs[allOutputs.length - 1])) {
                    allOutputs.pop();
                }

                $sampleInput.val(allInputs.join(separator));
                $sampleOutput.val(allOutputs.join(separator));
            });
        });
    </script>
    {% if original and original.pk %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const heading = document.querySelector('#cases-group .module h2');
            const button = document.createElement('button');
            button.innerText = '테스트 케이스 미리보기';
            button.className = 'title-button';
            button.type = 'button';
            heading.appendChild(button);

            button.onclick = function() {
                window.open("{% url 'admin:testcase_preview' original.pk %}", "Popup", "width=600,height=400");  
            }
        });
    </script>
    {% endif %}
        
    <style>
        .datetime {
            display: flex;
            align-items: center;
            width:100%;
        }
        /* .datetime br{
            display:none !important;
        } */
        .datetime input.vDateField,
        .datetime input.vTimeField {
            margin-right: 10px;
        }

        .datetime .datetimeshortcuts {
            margin-right: 10px;
        }
        #content .inline-group {
            border-radius: 10px;
            overflow: hidden;
        }
        .title-button {
            margin-left: 15px; /* 제목과 버튼 사이의 간격 조정 */
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* 예제 추가 버튼 디자인 */
        #sample-io-add {
            position: relative;
        }
        #sample-io-add::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            transition: opacity 0.3s ease;
            opacity: 0;
        }
        #sample-io-add:hover {
            background: #4a8bc2 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(91, 155, 213, 0.35) !important;
        }
        #sample-io-add:hover::before {
            opacity: 1;
        }
        #sample-io-add:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(91, 155, 213, 0.3) !important;
        }
        
        /* 예제 삭제 버튼 (×) 디자인 */
        .sample-delete-btn {
            position: relative;
        }
        .sample-delete-btn:hover {
            background: #c82333 !important;
            transform: scale(1.15);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.5) !important;
        }
        .sample-delete-btn:active {
            transform: scale(1.05);
        }
    </style>
    
{% endblock extrahead %}

{% block after_field_sets %}{{ block.super }}
    {% if original %}
        <a style="display: none" title="{{ _('View submissions') }}" class="button submissions-link"
           href="{% url 'admin:judge_submission_changelist' %}?problem__code={{ original.code }}">
            <i class="fa fa-lg fa-search-plus"></i>
            <span class="text">{{ _('View submissions') }}</span>
        </a>
    {% endif %}
{% endblock %}